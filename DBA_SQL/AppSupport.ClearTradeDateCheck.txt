USE [DBA]
GO
/****** Object:  StoredProcedure [AppSupport].[ClearTradeDateCheck]    Script Date: 25/07/2018 09:58:37 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [AppSupport].[ClearTradeDateCheck] (@debug TINYINT = 0, @email_address VARCHAR(1000) ='stephen.hindmarsh@matthey.com;Kemi.llelaboye@matthey.com;satya.mula@matthey.com')

AS 
BEGIN

SET NOCOUNT ON

DECLARE @rowcount INT

IF OBJECT_ID('tempdb..##ClearTradeDateCheck') IS NOT NULL
DROP TABLE ##ClearTradeDateCheck

SELECT tran_num 
INTO ##ClearTradeDateCheck
FROM OLEME00P.dbo.ab_tran 
WHERE trade_date <> input_date
  AND tran_status in (1,3) 
  AND    tran_type = 0
  AND  ins_type IN (30201,26001,32007,12101,30001,12100)
  AND input_date = DATEADD(d,DATEDIFF(d,0,GETDATE()),0)


SELECT @rowcount = @@ROWCOUNT

IF @debug = 1 PRINT @rowcount

IF @rowcount > 0 
BEGIN

DECLARE @email_subject NVARCHAR(100)
DECLARE @email_query   NVARCHAR(2000)
DECLARE @profile_name SYSNAME
--DECLARE @email_address VARCHAR(500)

SET @email_subject = 'Warning - Clear Trade Date Check - FAILED'

  
SET @email_query = 'SELECT * from ##ClearTradeDateCheck'

IF @debug = 1 PRINT @email_query

SELECT  @profile_name =    name FROM msdb.dbo.sysmail_profile WHERE profile_id = 1

--SELECT @email_address = 'stephen.hindmarsh@matthey.com;Kemi.llelaboye@matthey.com;satya.mula@matthey.com'

--SELECT @email_address = 'stephen.hindmarsh@matthey.com'

IF @debug = 0 
BEGIN
 EXEC msdb.dbo.sp_send_dbmail  @profile_name = @profile_name,@recipients = @email_address,@subject = @email_subject,@query = @email_query,@importance = 'HIGH',@attach_query_result_as_file = 1
 DROP TABLE ##ClearTradeDateCheck
 RAISERROR ('ClearTradeDateCheck',16,1) 
 RETURN(1)
END

END

DROP TABLE ##ClearTradeDateCheck

END

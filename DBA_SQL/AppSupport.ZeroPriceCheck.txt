USE [DBA]
GO
/****** Object:  StoredProcedure [AppSupport].[ZeroPriceCheck]    Script Date: 25/07/2018 10:29:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [AppSupport].[ZeroPriceCheck] (@debug TINYINT = 0, @email_address VARCHAR(1000) ='stephen.hindmarsh@matthey.com')

AS 
BEGIN

SET NOCOUNT ON

DECLARE @rowcount INT

IF OBJECT_ID('tempdb..##ZeroPriceCheck') IS NOT NULL
DROP TABLE ##ZeroPriceCheck

SELECT ujpmd.deal_num, ujpmd.deal_leg, ujpmd.spot_rate, ujpmd.fwd_rate
INTO ##ZeroPriceCheck
FROM OLEME00P.dbo.USER_jm_pnl_market_data ujpmd
INNER JOIN OLEME00P.dbo.ab_tran ab
ON ujpmd.deal_num = ab.deal_tracking_num
WHERE    ujpmd.trade_date =  CONVERT(int,DATEADD(d,DATEDIFF(d,0,GETDATE()),0)) 
AND ab.tran_status = 3
  AND ( ujpmd.spot_rate < 0.01 OR ujpmd.fwd_rate < 0.01) 
  ORDER BY ujpmd.deal_num

SELECT @rowcount = @@ROWCOUNT

IF @debug = 1 PRINT @rowcount

IF @rowcount > 0 
BEGIN

DECLARE @email_subject NVARCHAR(100)
DECLARE @email_query   NVARCHAR(2000)
DECLARE @profile_name SYSNAME
--DECLARE @email_address VARCHAR(500)

SET @email_subject = 'Warning - Zero Price Check - FAILED'

  
SET @email_query = 'SELECT * from ##ZeroPriceCheck'

IF @debug = 1 PRINT @email_query

SELECT  @profile_name =    name FROM msdb.dbo.sysmail_profile WHERE profile_id = 1

--SELECT @email_address = 'stephen.hindmarsh@matthey.com;Kemi.llelaboye@matthey.com;satya.mula@matthey.com'

IF @debug = 0 
BEGIN
 EXEC msdb.dbo.sp_send_dbmail  @profile_name = @profile_name,@recipients = @email_address,@subject = @email_subject,@query = @email_query,@importance = 'HIGH',@attach_query_result_as_file = 1
 DROP TABLE ##ZeroPriceCheck
 RAISERROR ('ZeroPriceCheck',16,1) 
 RETURN(1)
END

END

DROP TABLE ##ZeroPriceCheck

END
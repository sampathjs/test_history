USE [DBA]
GO
/****** Object:  StoredProcedure [AppSupport].[LongRunningAutoConfirmCheck]    Script Date: 25/07/2018 10:00:13 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [AppSupport].[LongRunningAutoConfirmCheck] (@threshold INT = 10, @debug TINYINT = 0, @email_address VARCHAR(1000) ='stephen.hindmarsh@matthey.com')

AS 
BEGIN

SET NOCOUNT ON


DECLARE @timediff INT


SELECT @timediff =  DATEDIFF(MINUTE,run.start_time,GETDATE() )
FROM OLEME00P.dbo.bpm_definition def
INNER JOIN OLEME00P.dbo.bpm_running run
ON run.bpm_definition_id = def.id_number
WHERE bpm_name = 'Automated Confirmation Processing'

IF @debug = 1 
BEGIN
  IF @timediff IS NULL PRINT 'Not currently running' ELSE PRINT @timediff
  SELECT * FROM  OLEME00P.dbo.bpm_definition WHERE bpm_name = 'Automated Confirmation Processing'
END

IF @timediff >= @threshold
BEGIN

DECLARE @email_subject NVARCHAR(100)
--DECLARE @email_query   NVARCHAR(2000)
DECLARE @profile_name SYSNAME
--DECLARE @email_address VARCHAR(500)

SET @email_subject = 'Warning - Long running Auto Confirm Intraday TPM Process Check - FAILED - Delay = '+CONVERT(VARCHAR(10),@timediff) + ' minutes'

SELECT  @profile_name =    name FROM msdb.dbo.sysmail_profile WHERE profile_id = 1

--SELECT @email_address = 'stephen.hindmarsh@matthey.com;Kemi.llelaboye@matthey.com;satya.mula@matthey.com'

IF @debug = 0 
BEGIN
 EXEC msdb.dbo.sp_send_dbmail  @profile_name = @profile_name,@recipients = @email_address,@subject = @email_subject,@importance = 'HIGH'
 RAISERROR ('LongRunningAutoConfirmCheck',16,1) 
 RETURN(1)
END

END
 
END
USE [DBA]
GO
/****** Object:  StoredProcedure [AppSupport].[FxSettleDateCheck]    Script Date: 25/07/2018 09:59:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER  PROC [AppSupport].[FxSettleDateCheck] (@debug TINYINT = 0, @email_address VARCHAR(1000) ='stephen.hindmarsh@matthey.com')
AS 
BEGIN

SET NOCOUNT ON

DECLARE @rowcount INT

IF OBJECT_ID('tempdb..##FxSettleDateCheck') IS NOT NULL
DROP TABLE ##FxSettleDateCheck

SELECT ab.deal_tracking_num, ab.tran_status, ab.ins_type, ab.currency AS 'ab_Currency', ate.currency AS 'ate_currency', ab.tran_num, ate.para_position, ab.trade_date, ate.event_date, ab.settle_date, ates.accounting_date, ates.nostro_date, ate.para_date  
INTO ##FxSettleDateCheck
FROM OLEME00P.dbo.ab_tran ab
INNER JOIN OLEME00P.dbo.ab_tran_event ate ON ate.tran_num = ab.tran_num
INNER JOIN OLEME00P.dbo.ab_tran_event_settle ates ON ates.event_num = ate.event_num
INNER JOIN OLEME00P.dbo.system_dates sd ON 1 = 1
WHERE ab.settle_date <> ate.event_date
AND ab.tran_status in (3,4)
AND ate.event_type = 14
AND ab.ins_type not in (47006, 48010, 12101, 12100, 30201)
AND ate.currency in (53, 54, 55, 56, 58, 6, 62, 63)
AND ab.settle_date >= sd.business_date

SELECT @rowcount = @@ROWCOUNT

IF @debug = 1 PRINT @rowcount

IF @rowcount > 0 
BEGIN

DECLARE @email_subject NVARCHAR(100)
DECLARE @email_query   NVARCHAR(2000)
DECLARE @profile_name SYSNAME
--DECLARE @email_address VARCHAR(500)

SET @email_subject = 'Warning - FX Settle Date Check - FAILED'
  
SET @email_query = 'SELECT * from ##FxSettleDateCheck ORDER BY deal_tracking_num'

IF @debug = 1 PRINT @email_query

SELECT  @profile_name =    name FROM msdb.dbo.sysmail_profile WHERE profile_id = 1

--SELECT @email_address = 'stephen.hindmarsh@matthey.com;Kemi.llelaboye@matthey.com;satpal.panesar@matthey.com'

IF @debug = 0 
BEGIN
 EXEC msdb.dbo.sp_send_dbmail  @profile_name = @profile_name,@recipients = @email_address,@subject = @email_subject,@query = @email_query,@importance = 'HIGH',@attach_query_result_as_file = 1
 DROP TABLE ##FxSettleDateCheck
 RAISERROR ('FxSettleDateCheck',16,1) 
 RETURN(1)
END

END

DROP TABLE ##FxSettleDateCheck

END